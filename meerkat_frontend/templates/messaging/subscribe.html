{% extends 'messaging/base.html' %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/intlTelInput.css') }}" />
{% endblock %}

{% block body %}
<!-- CONTENT -->

<div class="container page-content">
	<div class="breaker"> </div>
	<div class="top-bar row">
		<div class="location-box box">
			<a href="#menu-toggle" id="menu-toggle" class="menu-toggle">
			<div class="location-box__label">
				<div>{{ _('Location:') }}</div>
				<div id="location-title" class="location-title" >{{ _('Not Loaded') }}</div>
			</div>
			<span class="glyphicon glyphicon-chevron-right"></span>
			<span class="glyphicon glyphicon-chevron-left hidden"></span>
			</a>
		</div>
		<div class="tab-title less-padding-col">
			 {{_('Public Health Surveillance Notifications')}}
		</div>
		<div id="epi-week-title" class="col-xs-12 col-sm-4 col-md-3 pull-right box ">
			{{_('Date not loaded.') }}
		</div>
	</div>


	<div class="toggled" id="wrapper">

		<div id="sidebar-wrapper" >
			<div id="location-selector" class="location-selector">
				{{ _('Locations not loaded') }}
			</div>
		</div>

	  <div id="page-content-wrapper">
		  <div class="row">
			  <div class="col-xs-12 less-padding-col">
				  <div class="box chartBox">
					  <div class="chartBox__heading">
						  {{ _('Subscribe to Alerts and Reports') }}
					  </div>
					  <div class="chartBox__content" >  
						  <div class="intro">
						  {{ _('Use the form below to subscribe to E-mail and SMS notifications for Alerts and Reports.') }}
						  </div>

						  <form class="subscribe row" id='subscribe-form' method='POST' action='subscribe/subscribed'>
							  <div class="left-part col-sm-12 col-md-6 more-padding-col">
								  <div class="personal">
									  <div class="title row">{{ _('Enter personal details') }}:</div>
									  <div class="row">
										  <label class="col-xs-12 col-sm-4" >{{ _('First Name*') }}</label>
										  <input class="col-xs-12 col-sm-8" type="text" name="first_name" required>
									  </div>
									  <div class="row">
										  <label class="col-xs-12 col-sm-4" >{{ _('Last Name*') }}</label>
										  <input class="col-xs-12 col-sm-8" type="text" name="last_name" required>
									  </div>
									  <div class="row">
										  <label class="col-xs-12 col-sm-4" >{{ _('E-mail*') }}</label>
										  <input id='email' class="col-xs-12 col-sm-8" type="email" name="email"
										         required oninput='checkEqual()'>
									  </div>
									  <div class="row">
									     <label class="col-xs-12 col-sm-4" >{{ _('Re-type E-mail*') }}</label>
										  <input class ="col-xs-12 col-sm-8" type="email" id="email2"
										         required oninput='checkEqual()'>
									  </div>
									  <div class="row">
									     <label class="col-xs-12 col-sm-4" >{{ _('SMS Number') }}</label>
										  <input id="sms-number" class="col-xs-12 col-sm-8" value="" type="tel" name="sms" optional>
									  </div>
								  </div>
								  <div id="report-select" class="row"> </div>
								  <div class="row">
									  <div class="col-xs-12 no-padding-col title" >
										 {{ _(' Select which location to receive Alerts from:') }}
									  </div>
									  <div class="col-xs-0 col-sm-4"></div>
									  <a href="" class="col-xs-12 col-sm-8 no-padding-col menu-toggle location-name"></a>
								  </div>
							  </div>
							  <input type="hidden" name="country" value="{{content.messages.country}}">
							  <div class="right-part col-sm-12 col-md-6 more-padding-col">
								  <div id="disease-select"> </div>
								  <div class="centered row">
									  <input class="submit btn btn-default btn-lg" type='submit' value="Subscribe" >
								  </div>
							  </div>

						  </form>
					  </div>
				  </div>
			  </div>
		  </div>
    </div>
	</div>
</div>
{% endblock body %}

{% block pageJS %}
<script src="{{ url_for('static', filename='js/intlTelInput.js') }}"></script>
<script type="text/javascript" >
  
var config = {{content|tojson|safe}};
var api_root = "{{config['EXTERNAL_API_ROOT']}}";
var week = {{week.epi_week}};

$(".menu-toggle").click(function(e) {
	e.preventDefault();
	$("#wrapper").toggleClass("toggled");
	$(".location-box .glyphicon").toggleClass( "hidden" );
});
loadLocationTree({ locID:{{loc}} });
$("#epi-week-title").html( "Week "+get_epi_week() + " Â· " + get_date() );

//This method updates aspects of the page based upon the users input.
//All three arguments can be left undefined if necessary - all reports will update with current locID and year.
function drawCharts(locID, year, reports){

	//locID (the id of the location) is an optional argument.  
	//If it isn't set, look at the current page state locID, if that isn't set, default to 1.
	if( typeof locID == 'undefined' ){
		if( history.state === null || typeof history.state.locID == 'undefined' ) locID = 1;
		else locID = history.state.locID;
	}

	//Load the location data from the locations tree.
	var node = locations.first( {strategy: 'breadth'}, function(x){ return x.model.id===locID; });

	$('.location-name').html( node.model.text );

}

//Configure the telephone input field.
var telInput = $('#sms-number');
var preferred = {{content.subscribe.pre_countries|safe}};

telInput.intlTelInput({
	initialCountry: preferred[0],
	utilsScript: "{{ url_for('static', filename='js/utils.js') }}",
	preferredCountries: preferred,
	formatAsYouType: true
});

var reset = function(){
	telInput[0].setCustomValidity('');
};

telInput.blur(function() {
	reset()
	if ($.trim(telInput.val())) {
		if (telInput.intlTelInput("isValidNumber")) {
			telInput[0].setCustomValidity('');
		} else {
			telInput[0].setCustomValidity("{{_('Not a valid phone number for this country.')}}" );
		}
	}
});

telInput.on("keyup change", reset);

//Draw the dynamic elements of the form.
$.getJSON( api_root+"/variables/alert", function( variables ){
	$.getJSON( api_root+"/locationtree", function( locations ){

		//Draw the disease Selector
		var disSel ="<div class='title  row'>{{_('Select which Alerts to receive:')}}</div>";

		disSel += "";
		disSel += "<div class='row'>";
		disSel += "<div class='col-xs-12 col-sm-6 col-md-4 check'>";
		disSel += "<input id='all-diseases' type='checkbox' value='allDis' name='topics'";
		disSel += "onclick='toggleAll(this); checkSelected(this);'>{{ _('All Alerts') }}</div> ";
		var keys = Object.keys(variables);

		for( var i in keys ){
			disSel += "<div class='col-xs-12 col-sm-6 col-md-4 check'>";
			disSel += "<input type='checkbox' class='disease' name='topics'";
         disSel += "onclick='checkSelected(this)' value='" + keys[i] + "'>";
			disSel += i18n.gettext(variables[keys[i]].name) + "</div>";
		}
		disSel += "</div>";
		$('#disease-select').html(disSel);

		//Draw the region selector
      var regSel = "<select id='region-selector'><option value='1'"+
		             "selected='selected'>";
      regSel += "All Regions </option>"  
      for( var k in locations.nodes ){
	  regSel += "<option name='regions' value='" +
                    locations.nodes[k].id + "' >" + i18n.gettext(locations.nodes[k].text) + "</option>"; 
      }
      regSel += "</select>";
		$('#region-select').html(regSel);

		//Draw the report selector
		var repSel = "<div class='title'> {{_('Select which Reports to receive:')}} </div>";
		repSel += "<div class='col-xs-0 col-sm-4'></div><div class='col-xs-12 col-sm-8 no-padding-col'>";
		for( var j in config.subscribe.reports ){
			repSel += "<div class='col-xs-12 col-sm-6 check'>";
			repSel += "<input type='checkbox' onclick='checkSelected(this);' class='reports'";
			repSel += "name='topics' value='" + config.subscribe.reports[j].id + "'>";
			repSel += i18n.gettext(config.subscribe.reports[j].name) + "</div>";
		}
		repSel += "</div>";
		$('#report-select').html(repSel);		

	});
});

//Toggle all disease checkboxes when all diseases are selected.
function toggleAll(source){
	$('.disease').each( function(){
		this.checked = source.checked;
		this.disabled = source.checked ? true : false;
	});
}

//FORM VALIDATION METHODS

//Check that the two e-mail address are equal
function checkEqual( ) {

	var email1 = document.getElementById('email');
	var email2 = document.getElementById('email2');

	if ( email2.value != email1.value ) {
		email2.setCustomValidity(" {{ _('Emails Must be Matching.') }} ");
		return false;
	} else {
		//Input is valid -- reset the error message
		email2.setCustomValidity('');
		return true;
	}
}

//Check that at least one checkbox is clicked
function checkSelected(input) {

	checked = $('input[name=topics]:checked').length;
	if(!checked) {
		input.setCustomValidity("{{_('You must tick at least one checkbox.') }}");
		return false;
	}else{
		boxes = document.getElementsByName('topics')
		for( var i=0; i<boxes.length; i++ ){
			boxes[i].setCustomValidity('');
		}
		return true;
	}
}

$("#subscribe-form").submit(function(event) {

	var valid = true;

	//Check validity
	if( !checkSelected( document.getElementById('all-diseases') ) ){
		checked = $('input[name=topics]').each( function(){
			this.setCustomValidity(" {{_('You must tick at least one checkbox.') }}");
		});		
		valid = false;
	}

	if( !checkEqual() ) valid = false;

	if( valid ){	

		//Get the formatted sms number, if it's not there remove it
		var number = telInput.intlTelInput("getNumber")
		if( number ){
			telInput.val(number);
		}else{
			telInput.remove();
		}

		//Assemble the topic IDs
		var prefix = '{{content.subscribe.topic_prefix}}';
		//Get the region		   
		var reg = history.state.locID

		$( 'input[name=topics]:checked' ).each( function(){

			//Remove everything up to the last hyphen
			//Old prefix can be retained in cache.
			var value = $(this).val();
			var parts = value.split("-");
			value = parts[parts.length-1]

			//Replace with new prefix.
			//Only add the region to disease topics (not needed for reports).
			if( $(this).hasClass('reports') ){
				$(this).val( prefix + value );
			}else{
				$(this).val( prefix + reg + "-" + value );
			}	

		});

    return;
		
	}

	event.preventDefault();
});
</script>

{% endblock pageJS %}
